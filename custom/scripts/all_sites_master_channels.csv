<#
Script Name: step0_setup_pipeline.ps1
Purpose    : Step 0 - Initialize positive "keep pipeline" structure, templates, and baseline copies.
Author     : ChatGPT (for Andrew)
Created    : 2025-11-23
Updated    : 2025-11-23
Version    : 1.0

Run Command:
PowerShell: C:\Users\Lenovo\PROJECTS\AJPs-custom-epg-master\AJPs-custom-epg-master\custom\scripts\step0_setup_pipeline.ps1

Notes:
- Creates custom\rules, custom\pipeline, custom\baseline, and related folders.
- Archives existing custom\data and custom\output (except master input) into custom\archive\<timestamp>\...
- Seeds rule templates and overrides.
- Copies all_sites_master_channels.csv into pipeline as remaining_00_master.csv.

#>

#region ---------- config ----------
$ErrorActionPreference = "Stop"

# Base project root (one level above \custom)
$BasePath   = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)

# Custom root
$CustomPath = Join-Path $BasePath "custom"

$DataPath     = Join-Path $CustomPath "data"
$OutputPath   = Join-Path $CustomPath "output"
$LogsPath     = Join-Path $CustomPath "logs"
$ArchivePath  = Join-Path $CustomPath "archive"
$RulesPath    = Join-Path $CustomPath "rules"
$PipelinePath = Join-Path $CustomPath "pipeline"
$BaselinePath = Join-Path $CustomPath "baseline"

# Versioned master folder inside data
$VersionedMasterPath = Join-Path $DataPath "versioned-master"

# Master input filename from Step 1
$MasterInputName = "all_sites_master_channels.csv"
$MasterInputPath = Join-Path $DataPath $MasterInputName

# Transcript / log
$Stamp   = Get-Date -Format "yyyyMMdd_HHmmss"
$LogFile = Join-Path $LogsPath "step0_setup_pipeline.log"
#endregion

#region ---------- logging helpers ----------
function Write-Log {
    param(
        [Parameter(Mandatory=$true)][string]$Message,
        [ValidateSet("INFO","WARN","ERROR","DEBUG")][string]$Level="INFO"
    )
    $ts = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $line = "[$ts][$Level] $Message"
    Write-Host $line
    Add-Content -Path $LogFile -Value $line
}

function Ensure-Folder {
    param([string]$Path)
    if (!(Test-Path $Path)) {
        New-Item -ItemType Directory -Force -Path $Path | Out-Null
        Write-Log "Created folder: $Path"
    } else {
        Write-Log "Folder exists: $Path" "DEBUG"
    }
}
#endregion

#region ---------- start ----------
Ensure-Folder $LogsPath
Start-Transcript -Path $LogFile -Append | Out-Null

Write-Log "Starting step0_setup_pipeline.ps1 v1.0"
Write-Log "BasePath=$BasePath"
Write-Log "CustomPath=$CustomPath"
Write-Log "DataPath=$DataPath"
Write-Log "OutputPath=$OutputPath"
Write-Log "RulesPath=$RulesPath"
Write-Log "PipelinePath=$PipelinePath"
Write-Log "BaselinePath=$BaselinePath"
Write-Log "ArchivePath=$ArchivePath"
Write-Log "Stamp=$Stamp"
#endregion

#region ---------- create core folders ----------
Ensure-Folder $ArchivePath
Ensure-Folder $RulesPath
Ensure-Folder $PipelinePath
Ensure-Folder $BaselinePath
Ensure-Folder $VersionedMasterPath
#endregion

#region ---------- archive existing clutter ----------
# We archive only if folders exist and have files other than the master input.
$ArchiveRunPath = Join-Path $ArchivePath $Stamp
Ensure-Folder $ArchiveRunPath

function Archive-Folder {
    param(
        [string]$SourceFolder,
        [string]$TargetSubFolder,
        [string[]]$ExcludeNames = @()
    )

    if (!(Test-Path $SourceFolder)) {
        Write-Log "Archive skip (missing folder): $SourceFolder" "DEBUG"
        return
    }

    $files = Get-ChildItem -Path $SourceFolder -File -ErrorAction SilentlyContinue |
             Where-Object { $ExcludeNames -notcontains $_.Name }

    if (!$files -or $files.Count -eq 0) {
        Write-Log "Archive skip (no files to move) in $SourceFolder" "DEBUG"
        return
    }

    $dest = Join-Path $ArchiveRunPath $TargetSubFolder
    Ensure-Folder $dest

    foreach ($f in $files) {
        $to = Join-Path $dest $f.Name
        Move-Item -Force -Path $f.FullName -Destination $to
        Write-Log "Archived file: $($f.FullName) -> $to"
    }
}

# Archive outputs fully
Archive-Folder -SourceFolder $OutputPath -TargetSubFolder "output"

# Archive data except master + versioned-master folder contents
Archive-Folder -SourceFolder $DataPath -TargetSubFolder "data" -ExcludeNames @($MasterInputName)

Write-Log "Archive complete for this run."
#endregion

#region ---------- validate master input ----------
if (!(Test-Path $MasterInputPath)) {
    Write-Log "ERROR: Missing master input $MasterInputPath. Step 1 must be run first." "ERROR"
    throw "Missing master input: $MasterInputPath"
}

# Basic sanity count
try {
    $masterRows = Import-Csv $MasterInputPath
    Write-Log "Loaded master input rows=$($masterRows.Count)"
} catch {
    Write-Log "ERROR: Cannot read master input CSV: $($_.Exception.Message)" "ERROR"
    throw
}
#endregion

#region ---------- seed pipeline remaining_00 ----------
$Remaining00 = Join-Path $PipelinePath "remaining_00_master.csv"
Copy-Item -Force -Path $MasterInputPath -Destination $Remaining00
Write-Log "Seeded pipeline remaining file: $Remaining00"
#endregion

#region ---------- create rule templates ----------
function Write-RuleTemplate {
    param(
        [string]$Path,
        [string]$StepLabel
    )

    if (Test-Path $Path) {
        Write-Log "Rule template exists (not overwriting): $Path" "DEBUG"
        return
    }

    $header = @(
        "step,group,include_regex,site_allow,country_allow,hd_policy,locality_policy,priority,notes"
    )

    $example = @(
        "$StepLabel,example_group,\bcbc\b|\bctv\b,epgshare01.online;tvguide.com,CA;US,prefer_sd,primary_only,1,edit me"
    )

    $content = $header + $example
    Set-Content -Path $Path -Value $content -Encoding UTF8
    Write-Log "Wrote rule template: $Path"
}

Write-RuleTemplate -Path (Join-Path $RulesPath "step1_rules.csv") -StepLabel "step1"
Write-RuleTemplate -Path (Join-Path $RulesPath "step2_rules.csv") -StepLabel "step2"
Write-RuleTemplate -Path (Join-Path $RulesPath "step3_rules.csv") -StepLabel "step3"
#endregion

#region ---------- create overrides ----------
function Write-OverrideTemplate {
    param(
        [string]$Path,
        [string]$TypeLabel
    )

    if (Test-Path $Path) {
        Write-Log "Override file exists (not overwriting): $Path" "DEBUG"
        return
    }

    $header = "site,name,xmltv_id,why"
    $example = "tvguide.com,CBC Toronto,CBC.ca@Toronto,always keep (example)"
    if ($TypeLabel -eq "drop") {
        $example = "pluto.tv,Fox News,FoxNews.us@East,never keep (example)"
    }

    Set-Content -Path $Path -Value @($header,$example) -Encoding UTF8
    Write-Log "Wrote override template: $Path"
}

Write-OverrideTemplate -Path (Join-Path $RulesPath "overrides_keep.csv") -TypeLabel "keep"
Write-OverrideTemplate -Path (Join-Path $RulesPath "overrides_drop.csv") -TypeLabel "drop"
#endregion

#region ---------- create baseline placeholders ----------
function Write-BaselinePlaceholder {
    param([string]$Path)

    if (Test-Path $Path) {
        Write-Log "Baseline placeholder exists (not overwriting): $Path" "DEBUG"
        return
    }

    $header = "display_name,country,site,xmltv_id,site_id,hd_flag,role,priority,notes"
    Set-Content -Path $Path -Value $header -Encoding UTF8
    Write-Log "Wrote baseline placeholder: $Path"
}

Write-BaselinePlaceholder -Path (Join-Path $BaselinePath "ajps_custom_channel_list.csv")
#endregion

#region ---------- finish ----------
Write-Log "Step 0 setup complete."
Stop-Transcript | Out-Null
#endregion
